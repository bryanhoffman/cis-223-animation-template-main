<!DOCTYPE html>
<html>
<head>
    <title>Mandelbrot Explorer Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { margin: 0; background: #111; color: #eee; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 320px; background: #222; padding: 20px; border-right: 1px solid #444; display: flex; flex-direction: column; box-shadow: 2px 0 10px rgba(0,0,0,0.5); }
        .group { margin-bottom: 15px; }
        label { display: block; font-size: 11px; color: #888; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 1px; }
        input, textarea, select { width: 100%; background: #000; border: 1px solid #444; color: #0f0; padding: 10px; box-sizing: border-box; font-family: 'Courier New', monospace; border-radius: 4px; }
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; cursor: pointer; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        #renderBtn { background: #3498db; color: white; }
        #renderBtn:hover { background: #2980b9; }
        #saveBtn { background: #27ae60; color: white; }
        #status { margin-top: 20px; color: #f1c40f; font-family: monospace; font-size: 13px; background: #000; padding: 10px; border-radius: 4px; border: 1px solid #333; }
        #viewer { flex-grow: 1; display: flex; align-items: center; justify-content: center; background: #050505; position: relative; }
        canvas { box-shadow: 0 0 50px #000; cursor: crosshair; background: #000; }
        h2 { margin-top: 0; color: #3498db; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>FRACTAL ENGINE</h2>
    
    <div class="group">
        <label>Famous Locations</label>
        <select id="presetPoints">
            <option value="none">-- Select a Spot --</option>
            <option value="-0.5, 0, 4.0">Full View (Default)</option>
            <option value="-0.74364388703715, 0.13182590420642, 0.0001">Seahorse Valley</option>
            <option value="-1.786444855998, 0, 0.0001">Triple Spiral</option>
            <option value="0.275, 0, 0.1">Elephant Valley</option>
            <option value="-0.52303311455273, 0.52633594081346, 0.0001">Mini-Mandelbrot</option>
        </select>
    </div>

    <div class="group">
        <label>Coordinate (a + bi)</label>
        <textarea id="coordInput" rows="3">-0.5 + 0i</textarea>
    </div>
    
    <div class="group">
        <label>Zoom (Range)</label>
        <input type="text" id="rangeInput" value="4.0">
    </div>
    
    <div class="group">
        <label>Detail (Iterations)</label>
        <input type="number" id="iterInput" value="500">
    </div>

    <div class="group">
        <label>Quality (Step)</label>
        <select id="stepInput">
            <option value="4">Draft (Fast)</option>
            <option value="2">Medium</option>
            <option value="1" selected>High (Detail)</option>
        </select>
    </div>

    <button id="renderBtn">RENDER VIEW</button>
    <button id="saveBtn">SAVE PNG</button>
    
    <div id="status">Ready. Click Render.</div>
</div>

<div id="viewer">
    <canvas id="mainCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
const PRECISION_BITS = 120n; 
const SCALE = 1n << PRECISION_BITS;

canvas.width = 1280;
canvas.height = 720;

function hslToRgb(h, s, l) {
    s /= 100; l /= 100;
    const k = n => (n + h / 30) % 12;
    const a = s * Math.min(l, 1 - l);
    const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, 9 - k(n), 1));
    const r = Math.round(255 * f(0)), g = Math.round(255 * f(8)), b = Math.round(255 * f(4));
    return `rgb(${r},${g},${b})`;
}

let isRendering = false;

function render() {
    if (isRendering) return;
    isRendering = true;

    const status = document.getElementById('status');
    const coords = document.getElementById('coordInput').value.match(/[-+]?[0-9]*\.?[0-9]+/g);
    const x_off = parseFloat(coords[0]);
    const y_off = parseFloat(coords[1]);
    const range = parseFloat(document.getElementById('rangeInput').value);
    const max_iter = parseInt(document.getElementById('iterInput').value);
    const step = parseInt(document.getElementById('stepInput').value);

    const x_off_bi = BigInt(Math.floor(x_off * Number(SCALE)));
    const y_off_bi = BigInt(Math.floor(y_off * Number(SCALE)));
    const y_rng_bi = BigInt(Math.floor(range * Number(SCALE)));
    const x_rng_bi = BigInt(Math.floor((range * (canvas.width/canvas.height)) * Number(SCALE)));
    const escape_limit = 4n << PRECISION_BITS;

    const canMirror = Math.abs(y_off) < 1e-18; 
    const totalTargetRows = canMirror ? canvas.height / 2 : canvas.height;

    const lut = [];
    for (let i = 0; i < max_iter; i++) {
        lut[i] = hslToRgb((i * 3) % 360, 100, 50);
    }
    lut[max_iter] = "#000000";

    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    let j = 0;
    const startTime = performance.now();

    function renderChunk() {
        const chunkHeight = 16; 
        const endRow = Math.min(j + chunkHeight, totalTargetRows);

        for (; j < endRow; j += step) {
            const y_val = (y_rng_bi * BigInt(j) / BigInt(canvas.height) - y_rng_bi / 2n) + y_off_bi;

            for (let i = 0; i < canvas.width; i += step) {
                const x_val = (x_rng_bi * BigInt(i) / BigInt(canvas.width) - x_rng_bi / 2n) + x_off_bi;

                let x_iter = x_val, y_iter = y_val, iteration = max_iter;
                let x_old = 0n, y_old = 0n;

                for (let k = 0; k < max_iter; k++) {
                    const x2 = (x_iter * x_iter) >> PRECISION_BITS;
                    const y2 = (y_iter * y_iter) >> PRECISION_BITS;
                    
                    if (x2 + y2 > escape_limit) { 
                        iteration = k; 
                        break; 
                    }

                    if ((k & 15) === 0) {
                        if (x_iter === x_old && y_iter === y_old) { 
                            iteration = max_iter; 
                            break; 
                        }
                        x_old = x_iter; y_old = y_iter;
                    }

                    y_iter = ((x_iter * y_iter) >> (PRECISION_BITS - 1n)) + y_val;
                    x_iter = x2 - y2 + x_val;
                }

                ctx.fillStyle = lut[iteration];
                ctx.fillRect(i, j, step, step);
                if (canMirror) {
                    ctx.fillRect(i, canvas.height - j - step, step, step);
                }
            }
        }

        if (j < totalTargetRows) {
            const percent = Math.min(100, Math.round((j / totalTargetRows) * 100));
            status.innerText = `Progress: ${percent}%`;
            requestAnimationFrame(renderChunk);
        } else {
            const totalTime = Math.round(performance.now() - startTime);
            status.innerText = `Done: ${totalTime}ms`;
            isRendering = false;
        }
    }
    renderChunk();
}

// Coordinate preset listener
document.getElementById('presetPoints').addEventListener('change', (e) => {
    if (e.target.value === "none") return;
    const [x, y, r] = e.target.value.split(',').map(s => s.trim());
    document.getElementById('coordInput').value = `${x} + ${y}i`;
    document.getElementById('rangeInput').value = r;
    render();
});

// Canvas Click to Center & Zoom
canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const px = (e.clientX - rect.left) / rect.width;
    const py = (e.clientY - rect.top) / rect.height;
    
    const coords = document.getElementById('coordInput').value.match(/[-+]?[0-9]*\.?[0-9]+/g);
    const range = parseFloat(document.getElementById('rangeInput').value);
    const aspect = canvas.width / canvas.height;
    
    const newX = parseFloat(coords[0]) + (px - 0.5) * (range * aspect);
    const newY = parseFloat(coords[1]) + (py - 0.5) * range;
    
    document.getElementById('coordInput').value = `${newX} + ${newY}i`;
    document.getElementById('rangeInput').value = (range * 0.2).toExponential(10);
});

document.getElementById('renderBtn').addEventListener('click', render);
document.getElementById('saveBtn').addEventListener('click', () => {
    canvas.toBlob(blob => saveAs(blob, "fractal_export.png"));
});
</script>
</body>
</html>