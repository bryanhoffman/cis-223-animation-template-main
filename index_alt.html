<!--DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="mandelbrot_gemini_collab.js" defer></script>
    <title>CIS 223 - Animation</title>
</head>
<body>
    
</body>
</html-->

<!DOCTYPE html>
<html>
<head>
    <title>Mandelbrot Capture</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { margin: 0; background: #111; color: white; font-family: sans-serif; overflow: hidden; }
        #controls { position: absolute; top: 10px; left: 10px; z-index: 10; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px; }
        canvas { display: block; width: 100vw; height: 100vh; object-fit: contain; }
        button { cursor: pointer; padding: 8px 16px; background: #2ecc71; border: none; color: white; border-radius: 4px; font-weight: bold; }
        button:disabled { background: #7f8c8d; }
    </style>
</head>
<body>

<div id="controls">
    <div id="status">Frame: 0</div>
    <button id="recordBtn">Start Recording (100 Frames)</button>
    <p style="font-size: 10px; margin-top: 5px;">Turn off "Ask where to save" in browser settings!</p>
</div>

<script>
// --- CONFIGURATION ---
const width = 1920;
const height = 1080;
let x_offset = -1.42884;
let y_offset = 0;
let x_range = 4.0; 
let y_range = 2.25;
const max_iter_val = 60;
const PRECISION_BITS = 80n; 
const SCALE = 1n << PRECISION_BITS;

// --- STATE ---
let frameCount = 0;
let isRecording = false;
const TOTAL_FRAMES = 100;

// --- COLOR SETUP ---
function hslToRgb(h, s, l) {
    s /= 100; l /= 100;
    const k = n => (n + h / 30) % 12;
    const a = s * Math.min(l, 1 - l);
    const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, 9 - k(n), 1));
    return (255 << 24) | (Math.round(255 * f(4)) << 16) | (Math.round(255 * f(8)) << 8) | Math.round(255 * f(0));
}

const rainbowLUT = new Uint32Array(max_iter_val + 1);
for (let i = 0; i < max_iter_val; i++) {
    rainbowLUT[i] = hslToRgb((i * 12) % 360, 100, 50);
}
rainbowLUT[max_iter_val] = (255 << 24); // Black

// --- CORE RENDERER ---
function renderMandelbrot(ctx) {
    const imgData = ctx.createImageData(width, height);
    const data32 = new Uint32Array(imgData.data.buffer);

    let x_off_bi = BigInt(Math.floor(x_offset * Number(SCALE)));
    let y_off_bi = BigInt(Math.floor(y_offset * Number(SCALE)));
    let x_rng_bi = BigInt(Math.floor(x_range * Number(SCALE)));
    let y_rng_bi = BigInt(Math.floor(y_range * Number(SCALE)));

    for (let j = 0; j < height / 2; j++) {
        for (let i = 0; i < width; i++) {
            let x_val = (x_rng_bi * BigInt(i) / BigInt(width) - x_rng_bi / 2n) + x_off_bi;
            let y_val = (y_rng_bi * BigInt(j) / BigInt(height) - y_rng_bi / 2n) + y_off_bi;

            let x_iter = x_val, y_iter = y_val, iteration = max_iter_val; 

            for (let k = 0; k < max_iter_val; k++) {
                let x2 = (x_iter * x_iter) >> PRECISION_BITS;
                let y2 = (y_iter * y_iter) >> PRECISION_BITS;
                if (x2 + y2 > (4n << PRECISION_BITS)) { iteration = k; break; }
                y_iter = ((x_iter * y_iter) >> (PRECISION_BITS - 1n)) + y_val;
                x_iter = x2 - y2 + x_val;
            }

            const pixelColor = rainbowLUT[iteration];
            data32[j * width + i] = pixelColor;
            data32[(height - 1 - j) * width + i] = pixelColor;
        }
    }
    ctx.putImageData(imgData, 0, 0);
}

// --- MAIN LOOP & SAVING ---
const canvas = document.createElement("canvas");
canvas.width = width; canvas.height = height;
document.body.appendChild(canvas);
const context = canvas.getContext("2d");

function loop() {
    renderMandelbrot(context);
    
    document.getElementById('status').innerText = `Frame: ${frameCount}`;

    if (isRecording && frameCount < TOTAL_FRAMES) {
        // Use FileSaver.js to save the frame
        const fileName = `mandelbrot_frame_${frameCount.toString().padStart(3, '0')}.png`;
        
        canvas.toBlob((blob) => {
            saveAs(blob, fileName);
        });

        frameCount++;
    } else if (frameCount >= TOTAL_FRAMES) {
        isRecording = false;
        document.getElementById('recordBtn').innerText = "Finished!";
        document.getElementById('recordBtn').disabled = true;
    }

    // Zoom speed
    x_range *= 0.98;
    y_range *= 0.98;

    requestAnimationFrame(loop);
}

document.getElementById('recordBtn').addEventListener('click', () => {
    isRecording = true;
    document.getElementById('recordBtn').innerText = "Recording...";
    document.getElementById('recordBtn').disabled = true;
});

loop();
</script>
</body>
</html>